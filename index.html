<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Antrian Surat Izin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Library untuk membaca & menulis file Excel (.xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="file"] { display: none; }
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .submenu.open {
            max-height: 1000px; /* Cukup besar untuk menampung item */
        }
        .menu-item.active {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        .dark .menu-item.active {
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .menu-item.active svg.arrow {
            transform: rotate(90deg);
        }
        /* Animated Brand */
        .animated-brand {
            background: linear-gradient(90deg, #38bdf8, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-animation 5s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* 3D Box Style */
        .box-3d {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-bottom: 4px solid #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
            position: relative;
        }
        .dark .box-3d {
            background-color: #1e293b;
            border-color: #334155;
            border-bottom-color: #0f172a;
        }
        /* Dark Theme */
        .dark, .dark body { background-color: #0f172a; color: #cbd5e1; }
        .dark aside, .dark .middle-panel { border-color: #334155; }
        .dark main { background-color: transparent; }
        .dark h1, .dark h2, .dark .font-semibold { color: #f1f5f9; }
        .dark p, .dark label, .dark .text-slate-700, .dark .text-slate-500, .dark .text-slate-600 { color: #94a3b8; }
        .dark .menu-item { color: #cbd5e1; }
        .dark .menu-item:hover { background-color: #334155; }
        .dark #submenu-database button, .dark #submenu-database label { color: #94a3b8; }
        .dark #submenu-database button:hover, .dark #submenu-database label:hover { background-color: #334155; }
        .dark #search-form { background-color: transparent; }
        .dark input, .dark select { background-color: #334155; border-color: #475569; color: #f1f5f9; }
        .dark input::placeholder { color: #64748b; }
        .dark input:disabled { background-color: #334155; opacity: 0.5; }
        .dark #kelas { background-color: #1e293b; }
        .dark #queue-container { background-color: #1e293b; border-color: #334155; }
        .dark #queue-container tr { border-color: #334155; }
        .dark #queue-container thead { background-color: #334155; }
        .dark #queue-container tbody tr { background-color: #1e293b; }
        .dark #queue-container tbody tr:hover { background-color: #334155; }
        .dark .text-slate-800 { color: #f1f5f9; }
        .dark .text-slate-900 { color: #f8fafc; }
        .dark #manual-add-modal > div, .dark #confirm-modal > div, .dark #settings-modal > div, .dark #import-preview-modal > div, .dark #notification-modal > div { background-color: #1e293b; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 dark:bg-slate-900">

    <div class="flex min-h-screen p-4 gap-4">
        <!-- Wrapper untuk Kolom Kiri dan Tengah (45%) -->
        <div class="w-[45%] flex flex-col gap-4">
            <!-- Header 3D Gabungan -->
            <div class="box-3d p-4 rounded-lg text-center">
                <p class="text-lg font-bold tracking-widest uppercase animated-brand">Madda Soft Production</p>
                <div class="flex justify-center items-baseline space-x-2 mt-1">
                    <h2 class="text-xs font-normal text-slate-600 dark:text-slate-400">SISwa (Sistem Ijin Siswa)</h2>
                    <p class="text-xs text-slate-500">v3.0</p>
                </div>
            </div>

            <!-- Kontainer untuk dua kolom di bawah header -->
            <div class="flex flex-grow gap-4">
                <!-- Sidebar Kiri (44.44% dari 45% = 20% total) -->
                <aside class="w-[44.44%] box-3d rounded-lg p-6 flex flex-col flex-shrink-0">
                    <nav class="space-y-2 flex-grow overflow-y-auto pr-2">
                        <!-- Menu Database -->
                        <button id="menu-database" class="menu-item w-full flex items-center justify-between p-3 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
                            <span class="font-semibold">Database Siswa</span>
                            <svg class="arrow w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <ul id="submenu-database" class="submenu space-y-1 mt-1 pl-4">
                            <li><button id="open-manual-add-modal" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Tambah Siswa</span></button></li>
                            <li>
                                <label for="excel-file-input" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm block cursor-pointer flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span>Impor .xlsx</span></label>
                                <input type="file" id="excel-file-input" accept=".xlsx, .xls">
                            </li>
                            <li><button id="download-template-button" class="w-full text-left p-2 rounded-md text-slate-600 hover:bg-slate-100 text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Unduh Template</span></button></li>
                            <li><button id="delete-database-button" class="w-full text-left p-2 rounded-md text-red-600 hover:bg-red-50 text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>Hapus Database</span></button></li>
                        </ul>
                    </nav>
                    
                    <div class="mt-auto flex justify-between items-center text-xs text-slate-400 pt-4 border-t dark:border-slate-700">
                        <span id="database-info">Menghubungkan...</span>
                        <button id="open-settings-modal" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                    </div>
                </aside>

                <!-- Panel Tengah (55.56% dari 45% = 25% total) -->
                <div class="w-[55.56%] box-3d rounded-lg p-6 flex flex-col flex-shrink-0">
                     <!-- Form Pencarian -->
                    <div>
                        <p id="active-date-display" class="text-lg font-semibold text-sky-600 dark:text-sky-400 mb-4 text-center">Memuat tanggal...</p>
                        <form id="search-form" class="space-y-4 relative p-3">
                            <div>
                                <label for="search-nama" class="block text-sm font-medium text-slate-600 mb-1">Nama Siswa</label>
                                <input type="text" id="search-nama" name="nama" autocomplete="off" placeholder="Ketik nama..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500 disabled:bg-slate-50">
                                <div id="autocomplete-results" class="absolute z-10 w-full bg-white border border-slate-200 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg hidden dark:bg-slate-700 dark:border-slate-600"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="kelas" class="block text-sm font-medium text-slate-600 mb-1">Kelas</label>
                                    <input type="text" id="kelas" name="kelas" readonly class="mt-1 block w-full px-3 py-2 bg-slate-100 border-slate-300 rounded-md text-sm">
                                </div>
                                 <div>
                                    <label for="wali" class="block text-sm font-medium text-slate-600 mb-1">Orang Tua / Wali</label>
                                    <input type="text" id="wali" name="wali" required placeholder="Nama Wali" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500">
                                </div>
                            </div>
                            <div>
                                <label for="keterangan" class="block text-sm font-medium text-slate-600 mb-1">Keterangan</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <select id="keterangan" name="keterangan" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-sky-500">
                                        <option>Sakit</option>
                                        <option>Izin</option>
                                    </select>
                                    <button type="submit" id="add-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 disabled:bg-indigo-300 whitespace-nowrap">
                                        + Tambah
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Utama (55%) -->
        <main class="w-[55%] box-3d rounded-lg p-6 flex flex-col">
             <h2 id="queue-title" class="text-xl font-semibold text-center mb-4">Daftar Izin Siswa</h2>
            <div id="queue-container" class="flex-grow overflow-y-auto bg-white rounded-lg border border-slate-200 shadow-inner">
                <!-- Tabel atau pesan kosong akan dirender di sini -->
            </div>
             <div id="main-action-buttons" class="flex justify-center items-center space-x-4 pt-4 mt-auto">
                <button id="reset-queue-button" class="text-sm text-orange-600 hover:text-orange-800 font-semibold">Hapus Antrian</button>
                <button id="print-pdf-button" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-md hover:bg-blue-700 text-sm">Cetak Laporan</button>
                <button id="print-slips-button" class="bg-emerald-600 text-white font-bold py-2 px-5 rounded-md hover:bg-emerald-700 text-sm">Cetak Izin Siswa</button>
            </div>
            <footer class="text-center text-xs text-slate-400 pt-4">
                Design & Creative 2025 By : Madda soft Feat Gemini
            </footer>
        </main>
    </div>

    <!-- Modal Tambah Siswa Baru -->
    <div id="manual-add-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Tambah Siswa Baru ke Database</h2>
                <button id="close-manual-add-modal-button" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <form id="manual-add-form" class="space-y-4">
                 <p class="text-sm text-slate-600">Siswa yang ditambahkan di sini akan langsung bisa dicari.</p>
                 <div>
                    <label for="manual-nama" class="block text-sm font-medium text-slate-700">Nama Siswa Baru</label>
                    <input type="text" id="manual-nama" placeholder="Nama Lengkap" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                 </div>
                 <div>
                    <label for="manual-kelas" class="block text-sm font-medium text-slate-700">Kelas</label>
                    <input type="text" id="manual-kelas" placeholder="Contoh: 9A" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                 </div>
                 <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Tambah ke Database</button>
            </form>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 id="confirm-title" class="text-lg font-bold mb-4">Konfirmasi Aksi</h3>
            <p id="confirm-message" class="text-sm text-slate-600 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-md text-sm font-medium bg-slate-100 hover:bg-slate-200 dark:bg-slate-600 dark:hover:bg-slate-500">Batal</button>
                <button id="confirm-ok-btn" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
    
    <!-- Generic Notification Modal -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 id="notification-title" class="text-lg font-bold mb-4">Informasi</h3>
            <p id="notification-message" class="text-sm text-slate-600 mb-6">Pesan notifikasi.</p>
            <div class="flex justify-end">
                <button id="notification-ok-btn" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Pengaturan</h2>
                <button id="close-settings-modal-button" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="font-semibold mb-2">Tema Tampilan</h3>
                     <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="theme-setting" value="light" checked>
                            <span>Cerah</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="theme-setting" value="dark">
                            <span>Gelap</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Preview Modal -->
    <div id="import-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl h-3/4 flex flex-col">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Pratinjau Impor Data</h2>
                <button id="close-import-preview-button" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div class="grid grid-cols-2 gap-4 flex-grow overflow-hidden">
                <div class="flex flex-col">
                    <h3 id="new-students-title" class="font-semibold mb-2 text-green-600">Siswa Baru (0)</h3>
                    <ul id="new-students-list" class="flex-grow overflow-y-auto border rounded-md p-2 bg-slate-50 dark:bg-slate-800 dark:border-slate-600"></ul>
                </div>
                <div class="flex flex-col">
                    <h3 id="duplicate-students-title" class="font-semibold mb-2 text-amber-600">Data Duplikat (Diabaikan) (0)</h3>
                    <ul id="duplicate-students-list" class="flex-grow overflow-y-auto border rounded-md p-2 bg-slate-50 dark:bg-slate-800 dark:border-slate-600"></ul>
                </div>
            </div>
            <div class="flex justify-end mt-4">
                 <button id="confirm-import-btn" class="px-6 py-2 rounded-md font-semibold text-white bg-sky-600 hover:bg-sky-700">Konfirmasi & Tambah</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Initialization ---
        async function initializeAppCore() {
            // --- STATE MANAGEMENT ---
            let studentDatabase = []; // Local cache for autocomplete
            let printQueue = [];
            let selectedStudent = null;
            let onConfirmCallback = null;
            const activeDate = new Date();
            let currentTheme = localStorage.getItem('appTheme') || 'light';
            let studentsToImport = [];
            let db, auth; // Firebase services
            let studentsUnsubscribe = null; // To detach listeners
            let queueUnsubscribe = null;

            // --- DATE & ID FORMATTING ---
            const todayId = activeDate.toISOString().slice(0, 10); // Firestore-friendly format

            // --- DOM ELEMENTS ---
            const databaseInfo = document.getElementById('database-info');
            const searchInput = document.getElementById('search-nama');
            const addButton = document.getElementById('add-button');
            const queueContainer = document.getElementById('queue-container');
            const queueTitle = document.getElementById('queue-title');
            const searchForm = document.getElementById('search-form');
            const classInput = document.getElementById('kelas');
            const waliInput = document.getElementById('wali');
            const reasonSelect = document.getElementById('keterangan');
            const autocompleteResults = document.getElementById('autocomplete-results');
            const activeDateDisplay = document.getElementById('active-date-display');

            // Modals
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            
            const notificationModal = document.getElementById('notification-modal');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationOkBtn = document.getElementById('notification-ok-btn');

            // --- UTILITY FUNCTIONS (MODALS, NOTIFICATIONS) ---
            function showNotification(title, message) {
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                notificationModal.classList.remove('hidden');
                notificationModal.classList.add('flex');
            }

            function hideNotification() {
                notificationModal.classList.add('hidden');
                notificationModal.classList.remove('flex');
            }

            function showConfirmation(title, message, onConfirm) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                onConfirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
            }

            function hideConfirmation() {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                onConfirmCallback = null;
            }

            // --- RENDER FUNCTIONS ---
            function renderQueue() {
                if (!queueContainer || !queueTitle) return;
                queueContainer.innerHTML = '';
                queueTitle.textContent = `Daftar Izin Siswa (${printQueue.length})`;

                if (printQueue.length === 0) {
                    queueContainer.innerHTML = `<div class="h-full flex items-center justify-center"><p class="text-base text-slate-400">Antrian kosong.</p></div>`;
                    return;
                }
                
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left text-slate-500';
                table.innerHTML = `
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0 dark:bg-slate-700 dark:text-slate-300">
                        <tr>
                            <th scope="col" class="px-6 py-3 w-12">No</th>
                            <th scope="col" class="px-6 py-3">Nama Siswa</th>
                            <th scope="col" class="px-6 py-3">Kelas</th>
                            <th scope="col" class="px-6 py-3">Orang Tua/Wali</th>
                            <th scope="col" class="px-6 py-3">Keterangan</th>
                            <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="queue-table-body"></tbody>`;
                
                const tableBody = table.querySelector('#queue-table-body');
                printQueue.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:hover:bg-slate-600';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${index + 1}</td>
                        <td class="px-6 py-4 font-semibold text-slate-800">${student.name}</td>
                        <td class="px-6 py-4">${student.class}</td>
                        <td class="px-6 py-4">${student.wali}</td>
                        <td class="px-6 py-4"><span class="font-medium text-amber-600">${student.reason}</span></td>
                        <td class="px-6 py-4 text-center">
                            <button data-index="${index}" class="remove-queue-btn text-red-500 hover:text-red-700 font-semibold">Hapus</button>
                        </td>`;
                    tableBody.appendChild(row);
                });
                
                queueContainer.appendChild(table);
            }

            function updateDatabaseInfo() {
                databaseInfo.textContent = `${studentDatabase.length} siswa di database.`;
                searchInput.disabled = studentDatabase.length === 0;
                if(studentDatabase.length > 0) searchInput.placeholder = "Ketik nama...";
                else searchInput.placeholder = "Database kosong...";
            }

            function updateDateDisplay() {
                activeDateDisplay.textContent = activeDate.toLocaleDateString('id-ID', {
                    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                });
            }

            function applyTheme(theme) {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('appTheme', theme);
                const themeRadio = document.querySelector(`input[name="theme-setting"][value="${theme}"]`);
                if(themeRadio) themeRadio.checked = true;
            }

            // --- FIRESTORE LOGIC ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            function setupFirestoreListeners(userId) {
                if (!db) return;
                
                if (studentsUnsubscribe) studentsUnsubscribe();
                if (queueUnsubscribe) queueUnsubscribe();

                const studentsRef = collection(db, `/artifacts/${appId}/public/data/students`);
                studentsUnsubscribe = onSnapshot(query(studentsRef), (snapshot) => {
                    studentDatabase = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateDatabaseInfo();
                }, (error) => {
                    console.error("Error listening to student database:", error);
                    showNotification("Error Database", "Gagal memuat data siswa. Coba refresh halaman.");
                });

                const queueDocRef = doc(db, `/artifacts/${appId}/public/data/dailyQueues`, todayId);
                queueUnsubscribe = onSnapshot(queueDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        printQueue = docSnap.data().queue || [];
                    } else {
                        printQueue = [];
                    }
                    renderQueue();
                }, (error) => {
                    console.error("Error listening to queue:", error);
                    showNotification("Error Antrian", "Gagal memuat data antrian. Coba refresh halaman.");
                });
            }

            async function addToQueue(event) {
                event.preventDefault();
                if (!selectedStudent) { showNotification('Error', 'Pilih siswa dari hasil pencarian terlebih dahulu.'); return; }
                const waliName = waliInput.value.trim();
                if(!waliName) { showNotification('Error', 'Nama Orang Tua / Wali harus diisi.'); return; }
                
                const isAlreadyInQueue = printQueue.some(student => student.name.toLowerCase() === selectedStudent.name.toLowerCase());
                if (isAlreadyInQueue) {
                    showNotification('Info', `Siswa bernama "${selectedStudent.name}" sudah ada di dalam antrian.`);
                    return;
                }

                const newQueueItem = { ...selectedStudent, reason: reasonSelect.value, wali: waliName, addedAt: new Date() };
                const updatedQueue = [...printQueue, newQueueItem];

                try {
                    const queueDocRef = doc(db, `/artifacts/${appId}/public/data/dailyQueues`, todayId);
                    await setDoc(queueDocRef, { queue: updatedQueue }, { merge: true });
                    selectedStudent = null;
                    searchForm.reset();
                    addButton.disabled = true;
                } catch (error) {
                    console.error("Error adding to queue:", error);
                    showNotification("Gagal", "Gagal menambahkan siswa ke antrian. Coba lagi.");
                }
            }
            
            async function removeFromQueue(index) {
                const updatedQueue = [...printQueue];
                updatedQueue.splice(index, 1);
                 try {
                    const queueDocRef = doc(db, `/artifacts/${appId}/public/data/dailyQueues`, todayId);
                    await setDoc(queueDocRef, { queue: updatedQueue });
                } catch (error) {
                    console.error("Error removing from queue:", error);
                    showNotification("Gagal", "Gagal menghapus siswa dari antrian. Coba lagi.");
                }
            }

            function resetQueue() {
                showConfirmation('Hapus Antrian?', 'Anda yakin ingin menghapus semua data antrian hari ini?', async () => {
                    try {
                        const queueDocRef = doc(db, `/artifacts/${appId}/public/data/dailyQueues`, todayId);
                        await setDoc(queueDocRef, { queue: [] });
                        showNotification("Berhasil", "Antrian hari ini telah dikosongkan.");
                    } catch (error) {
                        console.error("Error resetting queue:", error);
                        showNotification("Gagal", "Gagal mengosongkan antrian. Coba lagi.");
                    }
                });
            }
            
            async function addStudentToDatabase(event) {
                event.preventDefault();
                const newNameInput = document.getElementById('manual-nama');
                const newClassInput = document.getElementById('manual-kelas');
                const newName = newNameInput.value.trim();
                const newClass = newClassInput.value.trim();
                
                if (!newName || !newClass) { showNotification('Error', 'Nama dan Kelas siswa baru tidak boleh kosong.'); return; }
                if (studentDatabase.some(s => s.name.toLowerCase() === newName.toLowerCase())) {
                    showNotification('Info', 'Siswa dengan nama ini sudah ada di database.');
                    return;
                }

                try {
                    const studentRef = doc(collection(db, `/artifacts/${appId}/public/data/students`));
                    await setDoc(studentRef, { name: newName, class: newClass });
                    showNotification("Berhasil", `Siswa "${newName}" berhasil ditambahkan.`);
                    document.getElementById('manual-add-form').reset();
                    document.getElementById('manual-add-modal').classList.add('hidden');
                } catch (error) {
                    console.error("Error adding student:", error);
                    showNotification("Gagal", "Gagal menambahkan siswa. Coba lagi.");
                }
            }

            async function confirmImport() {
                if (studentsToImport.length === 0) {
                    showNotification("Info", "Tidak ada siswa baru untuk diimpor.");
                    return;
                }
                const batch = writeBatch(db);
                studentsToImport.forEach(student => {
                    const docRef = doc(collection(db, `/artifacts/${appId}/public/data/students`));
                    batch.set(docRef, student);
                });

                try {
                    await batch.commit();
                    showNotification("Berhasil", `${studentsToImport.length} siswa baru berhasil diimpor ke database.`);
                    document.getElementById('import-preview-modal').classList.add('hidden');
                } catch (error) {
                    console.error("Error importing students:", error);
                    showNotification("Gagal", "Terjadi kesalahan saat mengimpor data. Coba lagi.");
                }
            }

            function deleteDatabase() {
                 showConfirmation('Hapus Seluruh Database?', 'PERINGATAN: Aksi ini tidak bisa dibatalkan. Seluruh data siswa yang dimuat akan hilang.', async () => {
                    try {
                        const studentsRef = collection(db, `/artifacts/${appId}/public/data/students`);
                        const querySnapshot = await getDocs(studentsRef);
                        const batch = writeBatch(db);
                        querySnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        showNotification("Berhasil", "Seluruh database siswa telah dihapus.");
                    } catch (error) {
                        console.error("Error deleting database:", error);
                        showNotification("Gagal", "Gagal menghapus database. Coba lagi.");
                    }
                });
            }

            // --- OTHER CORE LOGIC (PDF, Excel, Search) ---
            function generatePDF(type) {
                if (printQueue.length === 0) {
                    showNotification("Info", "Tidak ada data untuk dicetak.");
                    return;
                }
                if (type === 'slips') generateSlipsPDF(printQueue, activeDate);
                else generateReportPDF(printQueue, activeDate);
            }

            function generateSlipsPDF(data, date) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                const panelW = pageW / 3;
                const panelH = pageH / 2;
                const margin = 8;

                const drawSlip = (x, y, student) => {
                    doc.setDrawColor(150, 150, 150);
                    doc.rect(x, y, panelW, panelH);
                    const contentX = x + margin;
                    const contentY = y + margin;
                    const contentW = panelW - (margin * 2);
                    let currentY = contentY;

                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    const title = "SURAT IJIN TIDAK MASUK SEKOLAH";
                    const titleWidth = doc.getTextWidth(title);
                    doc.text(title, x + (panelW / 2), currentY, { align: 'center' });
                    const underlineY = currentY + 1;
                    doc.setLineWidth(0.5);
                    doc.line(x + (panelW / 2) - (titleWidth / 2), underlineY, x + (panelW / 2) + (titleWidth / 2), underlineY);
                    currentY += 10;

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const p1 = "Surat ini menerangkan bahwa siswa tersebut dibawah ini telah diijinkan oleh orangtua/walinya untuk tidak masuk sekolah.";
                    doc.text(p1, contentX, currentY, { maxWidth: contentW });
                    currentY += 15;

                    doc.text("Nama", contentX, currentY);
                    doc.text(`: ${student.name}`, contentX + 25, currentY);
                    currentY += 7;
                    doc.text("Kelas", contentX, currentY);
                    doc.text(`: ${student.class}`, contentX + 25, currentY);
                    currentY += 7;
                    doc.text("Keterangan", contentX, currentY);
                    doc.text(`: ${student.reason}`, contentX + 25, currentY);
                    currentY += 14;

                    const p2 = "Mohon diteruskan kepada petugas presensi untuk dilaksanakan. Terima kasih.";
                    doc.text(p2, contentX, currentY, { maxWidth: contentW });

                    const signX = x + panelW - margin;
                    const signY = y + panelH - margin;
                    const formattedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                    
                    doc.text(`Jatirogo, ${formattedDate}`, signX, signY - 20, { align: 'right' });
                    doc.text("Petugas,", signX, signY - 15, { align: 'right' });
                    doc.text("Meri Wahyudi", signX, signY, { align: 'right' });
                };

                data.forEach((student, index) => {
                    const pageIndex = Math.floor(index / 6);
                    if (pageIndex > 0 && index % 6 === 0) doc.addPage();
                    const slipIndexOnPage = index % 6;
                    const col = slipIndexOnPage % 3;
                    const row = Math.floor(slipIndexOnPage / 3);
                    drawSlip(col * panelW, row * panelH, student);
                });
                
                doc.output('dataurlnewwindow');
            }

            function generateReportPDF(data, date) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const tableColumn = ["No", "Nama Siswa", "Kelas", "Orang Tua/Wali", "Keterangan"];
                const tableRows = data.map((s, i) => [i + 1, s.name, s.class, s.wali, s.reason]);
                const formattedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                doc.setFontSize(18);
                doc.text("Laporan Ijin Siswa", doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Tanggal: ${formattedDate}`, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });

                doc.autoTable({
                    head: [tableColumn], body: tableRows, startY: 30, theme: 'grid',
                    headStyles: { fillColor: [241, 245, 249], textColor: [20, 20, 20] },
                    styles: { fontSize: 10 },
                });
                
                doc.output('dataurlnewwindow');
            }

            function downloadTemplate() {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([["Nama", "Kelas"]]);
                XLSX.utils.book_append_sheet(wb, ws, "DataSiswa");
                XLSX.writeFile(wb, "template_siswa.xlsx");
            }
            
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    const header = jsonData[0];
                    if (!header || String(header[0]).trim() !== 'Nama' || String(header[1]).trim() !== 'Kelas') {
                        showNotification('Format Salah', 'Format file Excel salah! Kolom harus "Nama" dan "Kelas".');
                        return;
                    }

                    const dataRows = jsonData.slice(1);
                    const seenNames = new Set(studentDatabase.map(s => s.name.toLowerCase()));
                    const newStudents = [];
                    const duplicateStudents = [];

                    dataRows.forEach(row => {
                        const name = row[0] ? String(row[0]).trim() : '';
                        const studentClass = row[1] ? String(row[1]).trim() : '-';
                        if (name && studentClass) {
                            if (!seenNames.has(name.toLowerCase())) {
                                newStudents.push({ name, class: studentClass });
                                seenNames.add(name.toLowerCase()); // Add to seen set to handle duplicates within the file itself
                            } else {
                                duplicateStudents.push({ name, class: studentClass });
                            }
                        }
                    });
                    showImportPreview(newStudents, duplicateStudents);
                };
                reader.readAsArrayBuffer(file);
                event.target.value = '';
            }

            function showImportPreview(newStudents, duplicateStudents) {
                document.getElementById('new-students-list').innerHTML = newStudents.map(s => `<li>${s.name} (${s.class})</li>`).join('');
                document.getElementById('duplicate-students-list').innerHTML = duplicateStudents.map(s => `<li>${s.name} (${s.class})</li>`).join('');
                document.getElementById('new-students-title').textContent = `Siswa Baru (${newStudents.length})`;
                document.getElementById('duplicate-students-title').textContent = `Data Duplikat (Diabaikan) (${duplicateStudents.length})`;
                
                studentsToImport = newStudents;
                const modal = document.getElementById('import-preview-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function handleSearch(e) {
                const query = e.target.value.toLowerCase();
                autocompleteResults.innerHTML = '';
                if (query.length < 1) {
                    autocompleteResults.classList.add('hidden');
                    return;
                }
                const matches = studentDatabase.filter(s => s.name.toLowerCase().includes(query)).slice(0, 10);
                if (matches.length > 0) {
                    autocompleteResults.classList.remove('hidden');
                    matches.forEach(match => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item p-2 hover:bg-sky-500 hover:text-white cursor-pointer';
                        item.textContent = `${match.name} (${match.class})`;
                        item.dataset.name = match.name;
                        item.dataset.class = match.class;
                        autocompleteResults.appendChild(item);
                    });
                } else {
                    autocompleteResults.classList.add('hidden');
                }
            }
            
            function selectStudentFromSearch(student) {
                selectedStudent = student;
                searchInput.value = student.name;
                classInput.value = student.class;
                autocompleteResults.classList.add('hidden');
                addButton.disabled = false;
                waliInput.focus();
            }

            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() {
                document.getElementById('menu-database').addEventListener('click', (e) => {
                    e.currentTarget.classList.toggle('active');
                    document.getElementById('submenu-database').classList.toggle('open');
                });
                document.getElementById('excel-file-input').addEventListener('change', handleFileUpload);
                document.getElementById('download-template-button').addEventListener('click', downloadTemplate);
                document.getElementById('delete-database-button').addEventListener('click', deleteDatabase);
                
                searchInput.addEventListener('input', handleSearch);
                searchForm.addEventListener('submit', addToQueue);
                
                document.getElementById('main-action-buttons').addEventListener('click', (e) => {
                    if(e.target.id === 'reset-queue-button') resetQueue();
                    if(e.target.id === 'print-pdf-button') generatePDF('report');
                    if(e.target.id === 'print-slips-button') generatePDF('slips');
                });

                document.getElementById('manual-add-form').addEventListener('submit', addStudentToDatabase);
                document.getElementById('open-manual-add-modal').addEventListener('click', () => document.getElementById('manual-add-modal').classList.remove('hidden'));
                document.getElementById('close-manual-add-modal-button').addEventListener('click', () => document.getElementById('manual-add-modal').classList.add('hidden'));

                queueContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-queue-btn')) {
                        removeFromQueue(parseInt(e.target.dataset.index, 10));
                    }
                });
                
                autocompleteResults.addEventListener('click', (e) => {
                    if (e.target.classList.contains('autocomplete-item')) {
                        selectStudentFromSearch({ name: e.target.dataset.name, class: e.target.dataset.class });
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!searchForm.contains(e.target)) {
                        autocompleteResults.classList.add('hidden');
                    }
                });

                confirmOkBtn.addEventListener('click', () => {
                    if (typeof onConfirmCallback === 'function') onConfirmCallback();
                    hideConfirmation();
                });
                confirmCancelBtn.addEventListener('click', hideConfirmation);
                notificationOkBtn.addEventListener('click', hideNotification);

                // Settings Modal
                const settingsModal = document.getElementById('settings-modal');
                document.getElementById('open-settings-modal').addEventListener('click', () => settingsModal.classList.remove('hidden'));
                document.getElementById('close-settings-modal-button').addEventListener('click', () => settingsModal.classList.add('hidden'));
                document.querySelectorAll('input[name="theme-setting"]').forEach(radio => {
                    radio.addEventListener('change', (e) => applyTheme(e.target.value));
                });

                // Import Modal
                document.getElementById('close-import-preview-button').addEventListener('click', () => document.getElementById('import-preview-modal').classList.add('hidden'));
                document.getElementById('confirm-import-btn').addEventListener('click', confirmImport);
            }

            // --- APP ENTRY POINT ---
            try {
                // Use provided Firebase config
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up authentication listener
                onAuthStateChanged(auth, user => {
                    if (user) {
                        // User is signed in.
                        console.log("User authenticated with UID:", user.uid);
                        setupFirestoreListeners(user.uid);
                    } else {
                        // User is signed out. Detach listeners.
                        console.log("User is not authenticated.");
                        if (studentsUnsubscribe) studentsUnsubscribe();
                        if (queueUnsubscribe) queueUnsubscribe();
                    }
                });

                // Sign in the user
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Initial UI setup
                applyTheme(currentTheme);
                updateDateDisplay();
                renderQueue(); // Initial render
                setupEventListeners();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                databaseInfo.textContent = "Koneksi database gagal.";
                showNotification("Koneksi Gagal", "Tidak dapat terhubung ke database. Beberapa fitur mungkin tidak berfungsi. Silakan refresh halaman.");
            }
        }

        // --- Start the app ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAppCore);
        } else {
            initializeAppCore();
        }
    </script>
</body>
</html>
